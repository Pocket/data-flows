version: 2.1
  
# Parameters to control monorepo conditionals
parameters:
  has_data_products_changes:
    type: boolean
    default: false

# Workflow and job shortcuts
only_main_v2: &only_main_v2
  filters:
    branches:
      only:
        - main-v2

not_dev_main_v2: &not_dev_main_v2
  filters:
    branches:
      ignore:
        - dev-v2
        - main-v2

only_dev_v2: &only_dev_v2
  filters:
    branches:
      only:
        - dev-v2

has_data_products_changes: &has_data_products_changes
  when: << pipeline.parameters.has_data_products_changes >>


# Reusable commands for jobs
commands:
  no_op:
    steps:
      - run:
          name: Build Completed
          command: |
            echo "All build steps expected have completed."

# Jobs to be used by workflows
# Use of conditionals allow required checks to pass when build steps are not needed
# Conditionals will the trigger the appropriate steps for the appropriate folders/files
jobs:
  data_products_changes_build:
    docker:
      - image: prefecthq/prefect:2-python3.10
    steps:
      - when: 
          condition: has_data_products_changes
          steps:
          - checkout:
              path: ~/repo
          - run:
              command: |
                export PATH=/root/.local/bin:$PATH
                apt update
                apt install -y curl
                curl -sSL https://install.python-poetry.org | python3
                apt clean && apt autoremove -y
                rm -rf /var/lib/apt/lists/*
                poetry config virtualenvs.create false
                poetry install --no-ansi --only main,dev
                black --check .
                python -m pytest --cov=src --cov-report term-missing --cov-fail-under=100
              name: Install dependencies and run tests
      - no_op
    working_directory: ~/repo/data-products
workflows:
  data_products_changes_workflow:
    jobs: 
      - data_products_changes_build:
          <<: *not_dev_main_v2
          name: data-products build

# VS Code Extension Version: 1.5.1